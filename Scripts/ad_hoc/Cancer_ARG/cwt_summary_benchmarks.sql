create or replace view REPORTING.CANCER__ARG.CWT_SUMMARY_BENCHMARKS(
	STANDARD,
	DATE,
	FIN_YEAR,
	FIN_MONTH_NAME,
	GEOGRAPHY,
	ACTIVITY_TOTAL,
	ACTIVITY_COMPLIANT,
	ACTIVITY_BREACHES,
	ACTIVITY_PERFORMANCE,
	PREV_PERFORMANCE,
	CHANGE_IN_PERFORMANCE
) COMMENT='Table to populate monthly CWT performance summary for national benchmarks.\\nContact: jake.kealey@nhs.net'
 as

-- CTE to get base columns needed for output
WITH CWT_NATIONAL_BASE AS (
    SELECT 

    STANDARD,
    TO_DATE(DATE_PERIOD) AS DATE,
    FIN_YEAR,
    FIN_MONTH_NAME,
    ORGANISATION_CODE AS PROVIDER_CODE,
    ORGANISATION_NAME AS PROVIDER_NAME,
    
    NO_PATIENTS AS ACTIVITY_TOTAL,
    NO_COMPLIANT AS ACTIVITY_COMPLIANT,
    NO_BREACHES AS ACTIVITY_BREACHES

    FROM MODELLING.CANCER__CWT_NATIONAL.CWT_NATIONAL_MONTHLY cwt_m
    
    WHERE ROW_POPULATION_TYPE = 'Provider' 
    AND FIN_YEAR >= '2025/26'
),

--Use base CTE to get aggregated London data
CWT_LONDON AS (
    SELECT
        STANDARD,
        DATE,
        FIN_YEAR,
        FIN_MONTH_NAME,
        'London' AS GEOGRAPHY,
        SUM(ACTIVITY_TOTAL) AS ACTIVITY_TOTAL,
        SUM(ACTIVITY_COMPLIANT) AS ACTIVITY_COMPLIANT,
        SUM(ACTIVITY_BREACHES) AS ACTIVITY_BREACHES

    FROM CWT_NATIONAL_BASE

    --Join to get London grouping
    INNER JOIN "Dictionary"."dbo"."Organisation" org
    ON CWT_NATIONAL_BASE.PROVIDER_CODE = org."Organisation_Code"
    
    INNER JOIN "Dictionary"."dbo"."Organisation" org_2
    ON org."SK_ParentOrg_ID" = org_2."SK_OrganisationID"
    AND org_2."SK_ParentOrg_ID" = 234932 --London SK Org ID
    
    GROUP BY ALL 
),

--Use base CTE to get aggregated England data
CWT_ENGLAND AS (
    SELECT
        STANDARD,
        DATE,
        FIN_YEAR,
        FIN_MONTH_NAME,
        'England' AS GEOGRAPHY,
        SUM(ACTIVITY_TOTAL) AS ACTIVITY_TOTAL,
        SUM(ACTIVITY_COMPLIANT) AS ACTIVITY_COMPLIANT,
        SUM(ACTIVITY_BREACHES) AS ACTIVITY_BREACHES

    FROM CWT_NATIONAL_BASE
    
    GROUP BY ALL 
)

SELECT
    base.*,
    ACTIVITY_COMPLIANT / ACTIVITY_TOTAL AS ACTIVITY_PERFORMANCE,
    LAG(ACTIVITY_PERFORMANCE) OVER (PARTITION BY STANDARD, GEOGRAPHY ORDER BY DATE) AS PREV_PERFORMANCE,
    ACTIVITY_PERFORMANCE - PREV_PERFORMANCE AS CHANGE_IN_PERFORMANCE
    
FROM (
    SELECT * FROM CWT_LONDON
    UNION ALL
    SELECT * FROM CWT_ENGLAND
) base

WHERE STANDARD IN ('FDS', '31 Day', '62 Day');